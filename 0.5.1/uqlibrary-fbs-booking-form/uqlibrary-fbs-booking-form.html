<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="../uqlibrary-date-selector/uqlibrary-date-selector.html">

<!--
Element providing a simple timeline.

##### Example

    <uqlibrary-fbs-booking-form></uqlibrary-fbs-booking-form>

    <script>
      (function () {

        window.addEventListener('polymer-ready', function() {

          var bookingForm = document.querySelector('uqlibrary-fbs-booking-form');

          bookingForm.roomDetails = {
            id:       1
            room:     "Group Room 3",
            level:    "Level 3",
            building: "Biological Sciences Library",
            campus:   "St Lucia",
            summary:  "6 chairs, 1 table, PC, Large Screen, whiteboard.",
            image:    "image-thumb.jpg",
            imageLarge:    "image-large.jpg",

            timeslotLength: 30,     //in minutes
            maxBookingLength: 120,  //in minutes
            minBookingLength: 30    //in minutes
          };

          bookingForm.searchDate = new Date();        //search date and time
          bookingForm.searchDuration = 60;            //in minutes
          bookingForm.maxBookingDate = new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000);
        });

      }());
    </script>

@element uqlibrary-fbs-booking-form
@blurb Element providing a FBS booking form
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-fbs-booking-form
-->

<polymer-element name="uqlibrary-fbs-booking-form" attributes="roomDetails searchDate">

  <template>
    <link rel="stylesheet" href="uqlibrary-fbs-booking-form.css">

    <div class="booking-room-header" style="background-image: url('{{ roomDetails.imageLarge }}')">
      <h2>
          {{ roomDetails.room }} <br>
          <small>{{roomDetails | formatLocation }}</small>
      </h2>
    </div>

    <p class="booking-room-summary">{{ roomDetails.summary }}</p>

    <uqlibrary-date-selector searchDate="{{ searchDate }}"
                             searchDuration="{{ searchDuration }}"
                             maxBookingDate="{{ maxBookingDate }}"
                             bookingTimeslots = "{{ bookingTimeslots }}"
                             maxBookingLength="{{ roomDetails.maxBookingLength / roomDetails.timeslotLength }}"
                             on-time-selector-changed="{{ bookingSelectionChanged }}">
                             </uqlibrary-date-selector>

    <p class="booking-room-hint">Maximum booking duration is {{ roomDetails.maxBookingLength }} min, minimum booking duration is {{ roomDetails.minBookingLength }} min</p>
    <p class="booking-room-hint">
      <span class="hint-box selected"></span> - your current selection
      <span class="hint-box available"></span> - available time slot
      <span class="hint-box unavailable"></span> - unavailable time slot
    </p>

    <paper-toast id="infoToast" flex></paper-toast>

    <paper-fab
            id="createRoomBooking"
            icon="check"
            class="action"
            on-tap="{{ createRoomBooking }}"></paper-fab>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-fbs-booking-form', {
        /**
         * The `roomDetails` attribute object contains properties of the room
         *
         * @property roomDetails
         * @type object
         */

        /** The `searchDate` attribute represents search date/time value
         *
         * @property searchDate
         * @type Date
         *
         */

        /** The `maxBookingDate` attribute represents maximum valid booking day (eg can book up to a week in advance)
         *
         * @property maxBookingDate
         * @type Date
         *
         */

        /** The `searchDuration` attribute represents booking duration value in minutes
         *
         * @property searchDuration
         * @type Int
         *
         */

        searchDateChanged : function (oldValue, newValue) {

          console.log("FBS Booking Form: this.searchDate updated to: ");
          console.log(this.searchDate);

          //TODO: get timeslots for new search date from api for this room/date

          //generate mock time slots if mock data is used
          this.bookingTimeslots = this.createTimeslots(false);
          this.selectTimeslots();
        },

        created: function () {
          this.roomDetails = {};
          this.searchDate = new Date();
          this.searchDuration = 90;
          this.maxBookingDate = new Date();
          this.bookingTimeslots = [];
        },

        ready: function () {
          this.addEventListener('submit-form', this.createRoomBooking);
        },

        showInfoToast: function(text) {
          this.$.infoToast.text = text;
          this.$.infoToast.show();
        },

        validateSelection : function(selectedTimeslots) {
          var validation = {
            valid : true,
            message: 'Your booking was successfully created.'
          };

          if (selectedTimeslots.length == 0) {
            validation.valid = false;
            validation.message = "Please, make a valid selection.";
          } else if (selectedTimeslots.length > this.maxBookingLength / this.roomDetails.timeslotLength) {
            validation.valid = false;
            validation.message = "Current selection exceeds maximum booking duration. Please, make a valid selection.";
          }
          else if (!selectedTimeslots.every(function(element, index) {
                    return !(index < selectedTimeslots.length - 1 && element.endTime.valueOf() !== selectedTimeslots[index+1].startTime.valueOf());
                  })) {
            validation.valid = false;
            validation.message = "Current selection is not available. Please, make another selection.";
          }

          return validation;
          },

        createRoomBooking : function () {
          // get currently selected elements
          var selectedTimeslots = this.bookingTimeslots.filter(function(item) { return item.selected; });
          var validation = this.validateSelection(selectedTimeslots);

          if (!validation.valid){
            this.showInfoToast(validation.message);
          } else {

            console.log("Creating booking on " + this.searchDate.toDateString() + " for time slots from " + selectedTimeslots[0].startTime + " to " + selectedTimeslots[selectedTimeslots.length-1].endTime);

            //TODO: validate data via API
            //TODO: save booking via API

            this.showInfoToast(validation.message);

            //if booking is successful, fire event to indicate booking is done and move on to other page
            this.fire('booking-created',
                    {
                      bookingStart: selectedTimeslots[0].startTime,
                      bookingEnd: selectedTimeslots[selectedTimeslots.length - 1].endTime,
                      bookingRoomId: this.roomDetails.id,
                      bookingTitle: this.roomDetails.name,
                      bookingLocation: this.formatLocation(this.roomDetails)
                    });
          }
        },

        formatLocation : function (roomDetails) {
          var location = [];

          if (roomDetails.level !== undefined)
            location.push(roomDetails.level);

          if (roomDetails.building !== undefined)
            location.push(roomDetails.building);

          if (roomDetails !== undefined)
            location.push(roomDetails.campus);

          return location.join(", ");
        },

        selectTimeslots : function() {
          var duration = parseInt(Math.min(this.roomDetails.maxBookingLength, this.searchDuration)/this.roomDetails.timeslotLength);
          var remainingDuration = duration;
          var searchDate = this.searchDate;

          this.bookingTimeslots.every(function(element, index) {

            if (element.selectable
                    && ((searchDate >= element.startTime && searchDate < element.endTime) || remainingDuration < duration)) {
              element.selected = true;
              remainingDuration--;
            }

            //cannot break selection if there's an unavailable time slot
            return remainingDuration === duration
              || (remainingDuration > 0 && remainingDuration < duration && element.selectable);
          });
        },

        createTimeslots : function(setRandomAvailability) {
          var currentDate = new Date(this.searchDate.valueOf());
          currentDate.setHours(0, 0, 0, 0);

          var timeslots = [];

          for (var index = 0; index < parseInt(24 * 60 / this.roomDetails.timeslotLength); index++){
            var offset = index * this.roomDetails.timeslotLength;
            currentDate.setHours(0, offset, 0, 0);

            timeslots.push(
                    {
                      startTime: new Date(currentDate.valueOf()),
                      endTime: new Date(currentDate.setMinutes(currentDate.getMinutes() + this.roomDetails.timeslotLength)),
                      selected: false,
                      selectable: setRandomAvailability ? (index % this.searchDate.getDate()) % 5 != 0 : true
                    });
          }

          return timeslots;
        }

      });
    })();
  </script>

</polymer-element>
