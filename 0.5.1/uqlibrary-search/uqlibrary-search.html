<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-dropdown/paper-dropdown.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="../core-dropdown/core-dropdown.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../core-input/core-input.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<!--
Element providing library search.

##### Example

    <uqlibrary-search></uqlibrary-search>

@element uqlibrary-search
@blurb Element providing library search.
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-search
-->
<polymer-element name="uqlibrary-search">

  <template>
    <link rel="stylesheet" href="uqlibrary-search.css">

    <core-a11y-keys target="{{$.search}}"
                    keys="up down enter esc"
                    on-keys-pressed="{{onSearchKeys}}"></core-a11y-keys>

    <core-ajax id="ajax"
               url="{{ajaxQuery}}"
               on-core-response="{{ajaxQuerySuggestionsLoaded}}"
               handleAs="json">
    </core-ajax>

    <paper-shadow id="searchWrapper" class="card" z="1" horizontal layout center>

      <div id="searchIcon" relative>
        <core-icon-button icon="search" on-tap="{{onTapSearchIcon}}">
          <core-icon icon="{{$.filters.opened ? 'arrow-drop-up' : 'arrow-drop-down'}}"></core-icon>
        </core-icon-button>

      </div>

      <div id="search" flex>
        <label for="searchInput"></label>
        <input id="searchInput"
               is="core-input"
               aria-label="Search"
               placeholder="{{'Search ' + selectedSuggestionName}}"
               value="{{searchText}}"
               on-tap="{{onTapShowFilters}}">

        <paper-dropdown id="autosuggest"
                        class="no-padding"
                        relatedTarget="{{$.search}}"
                        autoFocusDisabled="true">
          <core-selector selected="{{selectedSuggestion}}"
                         selectedAttribute=""
                         id="suggestionSelector">
            <template repeat="{{suggestions}}">
              <paper-item on-tap="{{onTapSuggestion}}"><div class="truncate">{{name}}</div></paper-item>
            </template>
          </core-selector>
        </paper-dropdown>

        <paper-dropdown id="filters"
                        class="no-padding"
                        relatedTarget="{{$.searchIcon}}"
                        autoFocusDisabled="true">
          <core-selector selected="{{selectedFilter}}"
                         selectedAttribute=""
                         id="filterSelector">
            <template repeat="{{filter, idx in filters}}">
              <paper-item class="{{(idx+1) === filters.length ? 'last' : ''}}">
                <div class="truncate">{{filter.name}}</div>
              </paper-item>
            </template>
          </core-selector>
        </paper-dropdown>

      </div>

      <template if="{{searchText.length}}">
        <div id="searchClear">
          <core-icon-button icon="close" on-tap="{{onTapClearSearch}}"></core-icon-button>
        </div>
      </template>

    </paper-shadow>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-search', {
        ajaxQuery: '',
        selectedFilter: 0,
        selectedSuggestion: 0,
        selectedSuggestionName: '',
        searchText: '',
        searchTextOrig: '',
        searching: false,
        previousKey: '',

        summonApi: 'https://d3nm82zk9ronst.cloudfront.net/metadata/suggest/suggest',
        lrApi: 'https://app.library.uq.edu.au/api/search_suggestions?type=learning_resource',
        examsApi: 'https://app.library.uq.edu.au/api/search_suggestions?type=exam_paper',
        databaseApi: 'https://app.library.uq.edu.au/api/search_suggestions?type=database',

        summon: 'http://uq.summon.serialssolutions.com/search?q=',
        exams: 'https://www.library.uq.edu.au/exams/papers.php?stub=',
        lr: 'http://lr.library.uq.edu.au/search?q=',
        database: 'https://www.library.uq.edu.au/resources/database/#/?title=',
        journals: 'https://app.library.uq.edu.au/#/journals?S=AC_T_B&C=',
        catalogue: 'https://library.uq.edu.au/search~S7/X?search=',

        created: function () {
          this.filters = [
            { name: 'Library',
              type: 'all',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t',
              autoSuggest: true,
              api: this.summonApi},
            { name: 'Books',
              type: 'books',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Book%20%2F%20eBook,f%7CContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t%7CContentType,Book%20Chapter,f',
              autoSuggest: true,
              api: this.summonApi
            },
            { name: 'Journal articles',
              type: 'journal_articles',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t%7CContentType,Journal%20Article,f%7CContentType,Magazine%20Article,f',
              autoSuggest: true,
              api: this.summonApi
            },
            { name: 'Multimedia',
              type: 'multimedia',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t%7CContentType,Audio%20Recording,f%7CContentType,Spoken%20Word%20Recording,f%7CContentType,Video%20Recording,f%7CContentType,Streaming%20Video,f%7CContentType,Slide,f%7CContentType,Photograph,f%7CContentType,Music%20Recording,f%7CContentType,Music%20Score,f%7CContentType,Painting,f%7CContentType,Sheet%20Music,f%7CContentType,Poster,f%7CContentType,Art,f%7CContentType,Compact%20Disc,f%7CContentType,Drawing,f%7CContentType,Graphic%20Arts,f%7CContentType,Image,f%7CContentType,Kit,f',
              autoSuggest: true,
              api: this.summonApi
            },
            { name: 'Journals',
              type: 'journals',
              url: this.journals,
              autoSuggest: true,
              api: this.summonApi
            },
            { name: 'Databases',
              type: 'databases',
              url: this.database,
              autoSuggest: true,
              api: this.databaseApi
            },
            { name: 'Catalogue',
              type: 'catalogue',
              url: this.catalogue,
              autoSuggest: false
            },
            { name: 'Past exam papers',
              type: 'exam_papers',
              url: this.exams,
              autoSuggest: true,
              api: this.examsApi
            },
            { name: 'Course reading lists',
              type: 'learning_resources',
              url: this.lr, autoSuggest: true,
              api: this.lrApi
            }
          ];
          this.suggestions = [];
          this.selectedSuggestionName = this.filters[0].name.toLowerCase();
        },

        ready: function () {
          if (this.attributes.getNamedItem('focused')) {
            this.$.filters.opened = true;
            this.$.searchInput.focus();
          }
        },

        ajaxQueryChanged: function () {
          this.selectedSuggestion = -1;
          if (! this.$.ajax.loading) {
            this.$.ajax.go();
          }
        },

        ajaxQuerySuggestionsLoaded: function () {
          try {
            this.suggestions = this.processSuggestions(this.$.ajax.response);
            this.async(function () {
              if (this.suggestions.length > 1 && !this.searching) {
                this.$.autosuggest.opened = true;
              }
              else if (this.$.autosuggest.opened) {
                this.$.autosuggest.opened = false;
              }
            }, 100);
          } catch (e) {}
        },

        processSuggestions: function (suggestions) {
          var processed = [];
          var api = this.filters[this.selectedFilter].api;

          if (api === this.summonApi) {
            suggestions.result.forEach(function (s) {
              processed.push(s);
            });
          }
          else if (api === this.lrApi) {
            suggestions.forEach(function (s) {
              s.origName = s.name;
              s.name = s.name + ' (' + (s.course_title ? (s.course_title + '|') : '')  +
                (s.campus ? s.campus + ', ' : '') +
                (s.period ? s.period.toLowerCase() : '') +')';
              processed.push(s);
            });
          }
          else if (api === this.examsApi) {
            suggestions.forEach(function (s) {
              s.origName = s.name;
              s.name = s.name +' ('+ (s.course_title ? (s.course_title) : '') + ')';
              processed.push(s);
            });
          }
          else if (api === this.databaseApi) {
            suggestions.forEach(function (s) {
              s.origName = s.name;
              s.name = s.name + ' (' + (s.type == 'database' ? 'Database' : 'Subject Area')+')';
              processed.push(s);
            });
          }

          return processed;
        },

        selectedFilterChanged: function () {
          this.$.filters.opened = false;
          this.selectedSuggestionName = this.filters[this.selectedFilter].name.toLowerCase();
          this.async(function () {
            this.$.searchInput.focus();
          }, 100);
        },

        searchTextChanged: function () {
          if (this.searching) {
            this.$.autosuggest.opened = false;
            //this.$.filters.opened = false;
          }
          else if (! this.searchText.length) {
            this.$.autosuggest.opened = false;
            this.$.filters.opened = true;
            this.$.searchInput.focus();
          }
          else if (this.searchText.length < 3) {
            this.$.autosuggest.opened = false;
            this.$.filters.opened = false;
          }
          else {
            this.$.filters.opened = false;
            var filter = this.filters[this.selectedFilter];
            if (filter.autoSuggest) {
              this.ajaxQuery = filter.api +
                ((filter.api.indexOf('?') === -1) ? '?' : '&') +
                'prefix=' + encodeURIComponent(this.searchText);
            }
          }
        },

        onSearchKeys: function (ev) {
          if (ev.detail.key === 'down' && this.selectedSuggestion < (this.suggestions.length-1)) {
            this.selectedSuggestion++;
          }
          else if (ev.detail.key === 'up') {
            if (this.selectedSuggestion > 0) {
              this.selectedSuggestion--;
            } else {
              this.selectedSuggestion = -1;
            }
          }
          else if (ev.detail.key === 'enter') {
            if (this.selectedSuggestion >= 0 &&
              this.previousKey &&
              (this.previousKey === 'up' || this.previousKey === 'down')
            ) {
              this.updateSearchTextFromSuggestion();
              this.selectedSuggestion = -1;
            }
            this.search();
          }
          else if (ev.detail.key === 'esc') {
            this.selectedSuggestion = -1;
            this.$.autosuggest.opened = false;
            this.$.filters.opened = false;
          }
          this.previousKey = ev.detail.key;
        },

        updateSearchTextFromSuggestion: function () {
          var suggestion = this.suggestions[this.selectedSuggestion];
          this.searchText = suggestion.name;
          if (suggestion.origName) {
            this.searchTextOrig = suggestion.origName;
          }
        },

        onTapShowFilters: function () {
          if (! this.searchText) {
            this.$.filters.opened = true;
            this.$.searchInput.focus();
          }
        },

        onTapSuggestion: function () {
          this.async(function () {
            this.updateSearchTextFromSuggestion();
            this.search();
          }, 100);
        },

        onTapClearSearch: function () {
          this.selectedSuggestion = -1;
          this.searchText = '';
        },

        onTapSearchIcon: function () {
          this.$.filters.opened = true;
        },

        search: function () {
          if (this.searching) {
            return;
          }
          this.searching = true;
          if (this.$.autosuggest.opened) {
            this.$.autosuggest.opened = false;
          }
          var filter = this.filters[this.selectedFilter];
          var search = this.searchTextOrig ? this.searchTextOrig : this.searchText;

          if (filter.api === this.lrApi || filter.api === this.examsApi) {
            var s = search.split(" ");
            search = s[0];
          }
          if (filter.type === 'catalogue') {
            search = this.cleanSearchQuery(search);
          }

          var url = filter.url + encodeURIComponent(search);
          if (filter.urlAppend) {
            url += filter.urlAppend;
          }
          //console.log('Searching: ' + search);
          //console.log('URL: ' + url);
          document.location.href = url;
        },

        cleanSearchQuery: function (query) {
          // remove non-alphanumerical characters and multiple whitespaces
          return  query.replace( new RegExp( '[^a-zA-Z0-9 @]' , 'gi' ), " ").replace(new RegExp( "\\s+" , 'gi' ), " ");
        }

      });
    })();
  </script>

</polymer-element>
