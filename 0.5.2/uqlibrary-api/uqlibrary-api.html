<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<!--
Element providing access to UQ Library's API.

##### Example

    <uqlibrary-api></uqlibrary-api>

@element uqlibrary-api
@blurb Element providing access to UQ Library's API.
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-api
-->

<polymer-element name="uqlibrary-api" attributes="uri method auto">

  <template>


    <core-ajax
      id="ajax"
      url="{{url}}"
      headers="{{headers}}"
      auto="{{auto}}"
      method="{{method}}"
      handleAs="json"
      on-core-response="{{handleResponse}}"
      on-core-error="{{handleError}}"></core-ajax>
  </template>

  <script>
    (function() {
      Polymer('uqlibrary-api', {

        method: 'GET',
        auto: false,
        appProductionBaseUrl: 'https://app.library.uq.edu.au',
        baseApiUrl: 'https://app.library.uq.edu.au/api',
        mockDataFileUrl: '', // defines what mock data file to load if not on production
        mock: false,

        handleResponse: function (e) {
          var data = this.$.ajax.response;
          if(this.mock) {
            data = {mock : true, data: this.$.ajax.response};
          }
          this.fire('uqlibrary-api', data);
        },

        handleError: function (event, object, sender) {
          this.fire('uqlibrary-api', object.xhr);
        },

        ready: function() {
          // Check if mock data must be loaded
          if(((window.location.protocol + '//' + window.location.hostname) != this.appProductionBaseUrl) && this.mockDataFileUrl != ''  ) {
            this.mock = true;
          }

        },

        /**
         * Submits request
         * args - optional parameters
         * args = {
         *  addTimestamp : true //to avoid browser cache
         *  body: {} //data to be passed in the body as json (not form data)
         * }
         * @method get
         */
        get: function (args) {
          var url = '';
          //Check if mock data should be returned
          if(this.mock) {
            url = this.resolvePath('mock/' + this.mockDataFileUrl +'.json');
          }
          else {
            this.setHeaders();
            url = this.baseApiUrl + this.uri;

            if (args && args.addTimestamp) {
              url += (url.indexOf('?') >= 0 ? '&' : '?');
              url += "timestamp=" + (new Date()).getTime();
            }

            if (args && args.body) {
              this.$.ajax.contentType="application/json";
              this.$.ajax.body = JSON.stringify(args.body);
            }
          }

          this.url = url;
          this.$.ajax.go();
        },

        /**
         * Sets the headers for the API request.
         */
        setHeaders: function () {
          var cookie = this.getCookie('UQLID');
          if (cookie !== "undefined") {
            this.headers = {
              "X-Uql-Token": cookie
            };
          } else {
            return '';
          }
        },

        /**
         * Gets a cookie by name
         * @param name the name of the cookie to return
         * @returns {String}
         */
        getCookie: function (name) {
          var value = "; " + document.cookie;
          var parts = value.split("; " + name + "=");
          if (parts.length === 2) return parts.pop().split(";").shift();
        }
      });
    })();
  </script>

</polymer-element>
