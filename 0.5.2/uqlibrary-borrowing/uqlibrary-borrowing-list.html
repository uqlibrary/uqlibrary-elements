<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../paper-button/paper-button.html">
<script src="../moment/moment.js"></script>

<polymer-element name="uqlibrary-borrowing-list" attributes="items noItemsMessage">

  <template>
    <link rel="stylesheet" href="uqlibrary-borrowing-list.css">
    <div id="timeline">

      <div class="empty-items" hidden?="{{processedItems.length > 0}}"> {{ noItemsMessage }} </div>

      <template repeat="{{item, idx in processedItems}}">

        <template if="{{!item.isDivider}}">

        <div id="item-{{item.id}}" class="{{item.class}}">
          <div horizontal layout class="timeline-item-inner">
            <div class="date" vertical layout self-center>
              <div class="caption">
                {{item.dayPrefixText}}
              </div>
              <div class="subhead">
                {{item.day}}
              </div>
              <div class="caption">
                {{item.daySuffixText}}
              </div>
            </div>
            <div flex layout horizontal class="item" on-tap="{{itemSelected}}" data-item-id="{{item.id}}">
              <div flex class="item-inner">
                <div class="body1 inverse">{{item.title}}</div>
                <div class="caption inverse">{{item.subtitle}}</div>
                <div class="caption inverse">{{item.secondaryText}}</div>
              </div>
              <div layout vertical>
                <template repeat="{{action in item.actions}}">
                  <paper-button class="actionButton" raised href="{{action.url}}">{{action.title}}</paper-button>
                </template>
              </div>
              <div class="attentionIcon {{item.attentionIcon.type}}" layout horizontal end hidden?={{!item.attentionIcon.icon}}>
                <div class="tooltip caption inverse" flex>{{item.attentionIcon.text}}</div>
                <core-icon class="caption inverse" end-justified icon={{item.attentionIcon.icon}}></core-icon>
               </div>
            </div>
          </div>
        </div>

      </template>

      <template if="{{item.isDivider}}">
        <p class="timeline-divider">&nbsp;</p>
      </template>

    </template>
    </div>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-borrowing-list', {
        /**
         * The `items` attribute is an array of items to display on the timeline.
         *
         * @property items
         * @type array
         */

        /**
         * The `noitemsMessage` a message to display when there are no upcoming items
         *
         * @property noitemsMessage
         * @type String
         */

        noItemsMessage : 'You do not have any items',
        showEachDate: false,
        sortByDate: true,

        created: function () {
          this.items = [];
          this.processedItems = [];
        },

        /**
         * The 'item-selected' item is fired when a user taps on an item in timeline,
         * object containing item details is returned
         * @item item-selected
         */
        itemSelected: function(item, data, source) {
          var itemId = source.getAttribute('data-item-id');
          var selectedItem = this.items.filter(function(item){ return item.id == itemId; });
          this.fire('item-selected', selectedItem.length ? selectedItem[0] : undefined);
        },


        itemsChanged: function (changeValue) {
          var items = JSON.parse(JSON.stringify(this.items));
          var processed = [];

          // Sort by date (ascending) is necessary
          if(this.sortByDate) {
            items.sort(function (a, b) {
              var aDate = new Date(a.date).getTime();
              var bDate = new Date(b.date).getTime();
              if (aDate > bDate) {
                return 1;
              }
              if (aDate < bDate) {
                return -1;
              }
              return 0;
            });
          }

          var haveDivider = false;

          //build processed items lists for display in timeline
          for (var i = 0; i < items.length; i++) {

            items[i].date = new Date(items[i].date);

            if(!items[i].hasOwnProperty('day')) {
              items[i].day = items[i].date.getDate();
            }

            if(!items[i].hasOwnProperty('dayPrefixText')) {
              items[i].dayPrefixText = moment(items[i].date).format('ddd');
            }
            if(!items[i].hasOwnProperty('daySuffixText')) {
              items[i].daySuffixText = moment(items[i].date).format('MMM');
            }

            items[i].class += ' item-item';

            //same day items should not display date
            if (!this.showEachDate
              && i > 0
              && items[i].date.getDay() === items[(i-1)].date.getDay()
              && items[i].date.getDate() === items[(i-1)].date.getDate()) {
              items[i].day = '';
              items[i].dayPrefixText = '';
              items[i].daySuffixText = '';
            }

            //insert divider between past and upcoming
            if (i > 0 && !haveDivider
              && (new Date()).getTime() < items[i].date.getTime()
              && (new Date()).getTime() >= items[i-1].date.getTime()) {
              items[(i-1)].class += ' last';
              haveDivider = true;
              processed.push({
                isDivider: true
              });
            }

            processed.push(items[i]);
          }

          if (processed.length > 0) {
            processed[0].class += ' first';
          }

          this.processedItems = processed;
        }
      });
    })();
  </script>

</polymer-element>
