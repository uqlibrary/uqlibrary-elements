<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../core-image/core-image.html">

<polymer-element name="uqlibrary-course" layout center attributes="course">
  <template>
    <link rel="stylesheet" href="uqlibrary-courses.css">

    <div id="readingList" hidden?="{{readingList.length == 0}}">
      <paper-shadow class="card" z="1">
        <div class="subhead cardSection cardTitle">{{course.learning_resources.reading_lists.length}} Reading List for {{course.courseId}}</div>
          <template repeat="{{item in readingList }}">
            <a href="{{item.itemLink}}" target="_blank">
              <div class="body1 cardSection">
                <div class="link listItemSection listItemTitle">{{item.title}}</div>
                <div class="caption listItemSection listItemAuthor" hidden?="{{!item.author}}">
                  <i>{{item.author}} {{item.year}} </i>
                </div>

                <div class="caption listItemSection listItemNotes" hidden?="{{!item.notes && (!item.startPage || !item.endPage)}}">
                  <span hidden?="{{!item.startPage || !item.endPage}}">Pages from {{item.startPage}} to {{item.endPage}}<br></span>
                  {{item.notes | trimNotes}}
                </div>

                <div class="caption listItemSection listItemType">{{item.referenceType}} <span hidden?="{{!item.importance}}">- {{item.importance}}</span></div>
              </div>
            </a>
          </template>
          <a class="link" href="{{course.learning_resources.reading_lists.url}}" target="_blank" hidden?="{{course.moreItemsCount.readingLists == 0}}">
            <div class="cardSection">
              <div class="link listItemLink">
                  <core-icon class="link" icon="arrow-forward" id="arrow-icon"></core-icon> {{course.moreItemsCount.readingLists}} more {{course.moreItemsCount.readingLists == 1 ? 'item' : 'items'}}
              </div>
            </div>
          </a>
      </paper-shadow>
    </div>


    <paper-shadow class="card" z="1">
      <div class="subhead cardSection cardTitle">Past Exam Papers</div>

      <div class="body1 cardSection" hidden?="{{examPapers.length > 0}}">
        <div class="caption listItemSection listItemNotes">
          No Past Exam Papers for this course
        </div>
      </div>
      <template repeat="{{ paper in examPapers }}">
        <a class="link" href="{{paper.url}}" target="_blank">
          <div class="cardSection" >
            <div class="link listItemLink">
                {{paper.period}} ({{paper.url | extractExtension}})
            </div>
          </div>
        </a>
      </template>
      <a class="link" href="{{examPapersSearchUrl + course.courseId}}" target="_blank" hidden?="{{examPapers.length == 0}}">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" icon="arrow-forward" id="arrow-icon"></core-icon> {{course.moreItemsCount.examPapers}} more past exam {{course.moreItemsCount.examPapers == 1 ? 'paper' : 'papers'}}
          </div>
        </div>
      </a>
    </paper-shadow>

    <paper-shadow class="card" z="1">
      <div class="subhead cardSection cardTitle">Library Guides</div>
      <template repeat="{{ guide in libGuides }}">
        <a class="link" href="{{guide.url}}" target="_blank">
          <div class="cardSection" >
            <div class="link listItemLink">
              {{guide.title}}
            </div>
          </div>
        </a>
      </template>
      <div class="cardSection" hidden?="{{course.moreItemsCount.libGuides == 0}}">
        <div class="link listItemLink">
          <a class="link" href="{{libGuidesLinkUrl + course.SUBJECT}}" target="_blank">
            <core-icon class="link" icon="arrow-forward" id="arrow-icon"></core-icon> {{course.moreItemsCount.libGuides}} more library {{course.moreItemsCount.libGuides == 1 ? 'guide' : 'guides'}}
          </a>
        </div>
      </div>
    </paper-shadow>

    <paper-shadow class="card" z="1">
      <div class="subhead cardSection cardTitle">Electronic Course Profile</div>
      <a class="link" href="{{ecpLinkUrl + course.courseId}}" target="_blank">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" icon="arrow-forward" id="arrow-icon"></core-icon> Link to ECP
          </div>
        </div>
      </a>
    </paper-shadow>


    <paper-shadow class="card" z="1">
      <div class="subhead cardSection cardTitle">Study Help</div>
      <a class="link" href="http://guides.library.uq.edu.au/" target="_blank">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" src="icons/sign.svg" id="sign-icon"></core-icon> All Library Subject Guides
          </div>
        </div>
      </a>

      <a class="link" href="https://learn.uq.edu.au/webapps/login/?new_loc=%2Fwebapps%2Fblackboard%2Fexecute%2FenrollCourse%3Fcontext%3DCourse%26course_id%3D_13002_1" target="_blank">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" icon="extension" id="extension-icon"></core-icon> Library 101
          </div>
        </div>
      </a>

      <a class="link" href="https://www.library.uq.edu.au/services/assign/indexmail_tab2.phtml" target="_blank">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" icon="description" id="description-icon"></core-icon> Assignment Planner
          </div>
        </div>
      </a>

      <a class="link" href="https://learn.uq.edu.au/" target="_blank">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" src="icons/bb.svg" id="bb-icon"></core-icon> Learn.UQ
          </div>
        </div>
      </a>

      <a class="link" href="https://my.uq.edu.au/my_login_screen.html?id=396" target="_blank">
        <div class="cardSection">
          <div class="link listItemLink">
              <core-icon class="link" icon="event" id="event-icon"></core-icon> Exam Schedule
          </div>
        </div>
      </a>
    </paper-shadow>


  </template>

  <script>
    Polymer('uqlibrary-course', {

      /**
       * The `courses` attribute contains information about courses
       *
       * @property data
       * @type Object
       */

      publish: {
        course: {
        }
      },
      observe: {
        'course.learning_resources.reading_lists.items': 'courseReadingListItemsChanged',
        'course.learning_resources.exam_papers': 'courseExamPapersChanged',
        'course.library_guides': 'libraryGuidesChanged'
      },

      readingList:[],
      examPapers:[],
      libGuides: [],

      notesTrimLength: 90,
      visibleItemsCount: {
        readingLists: 2,
        examPapers: 2,
        libGuides: 2
      },
      examPapersSearchUrl: 'https://www.library.uq.edu.au/exams/papers.php?stub=',
      ecpLinkUrl: 'http://www.uq.edu.au/study/course.html?course_code=',
      libGuidesLinkUrl: 'http://guides.library.uq.edu.au/search.php?iid=4053&gid=0&c=0&search=',


      ready: function() {
        this.course.moreItemsCount = {
          readingLists: 0,
          examPapers: 0,
          libGuides: 0,
        };
      },

      created: function() {
      },

      extractExtension: function(url) {
        return url.substring(url.lastIndexOf('.')+1);
      },

      trimNotes: function(value) {
        if(value && value.length > this.notesTrimLength) {
          var _trimmed = value.substring(0, this.notesTrimLength);
          // trim on word boundary
          _trimmed = _trimmed.substring(0, _trimmed.lastIndexOf(' '));
          return (_trimmed + '...');
        }
        else
          return value;
      },

      courseReadingListItemsChanged: function(oldValue, newValue) {
        if(newValue) {
          // slice reading list array to show limited number items
          if(this.visibleItemsCount.readingLists && this.visibleItemsCount.readingLists > 0 && newValue.length >= this.visibleItemsCount.readingLists) {
            this.readingList = newValue.slice(0, this.visibleItemsCount.readingLists);
            this.course.moreItemsCount.readingLists = newValue.length - this.visibleItemsCount.readingLists;
          }
          else{
            this.readingList = newValue;
            this.course.moreItemsCount.readingLists = 0;
          }
        }
      },

      courseExamPapersChanged: function(oldValue, newValue) {
        if(newValue) {
          // slice reading list array to show limited number items
          if(this.visibleItemsCount.examPapers && this.visibleItemsCount.examPapers > 0 && newValue.length >= this.visibleItemsCount.examPapers) {
            this.examPapers = newValue.slice(0, this.visibleItemsCount.examPapers);
            this.course.moreItemsCount.examPapers = newValue.length - this.visibleItemsCount.examPapers;
          }
          else{
            this.examPapers = newValue;
            this.course.moreItemsCount.examPapers = 0;
          }
        }
      },

      libraryGuidesChanged: function(oldValue, newValue) {
        if(newValue) {
          // slice reading list array to show limited number items
          if(this.visibleItemsCount.libGuides && this.visibleItemsCount.libGuides > 0 && newValue.length >= this.visibleItemsCount.libGuides) {
            this.libGuides = newValue.slice(0, this.visibleItemsCount.libGuides);
            this.course.moreItemsCount.libGuides = newValue.length - this.visibleItemsCount.libGuides;
          }
          else{
            this.libGuides = newValue;
            this.course.moreItemsCount.libGuides = 0;
          }
        }
      }

    });
  </script>

</polymer-element>