<!--
Element providing an overview for student's courses

##### Example

    <uqlibrary-courses></uqlibrary-courses>

    <script>
    (function () {

      window.addEventListener('polymer-ready', function() {

        var courses = document.querySelector('uqlibrary-courses');

        courses.courses = [
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Financial Management",
              "SUBJECT": "FINM",
              "CATALOG_NBR": "2401",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Elect Commerce Systems Dev",
              "SUBJECT": "INFS",
              "CATALOG_NBR": "2244",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Working with Groups & Teams",
              "SUBJECT": "MGTS",
              "CATALOG_NBR": "2961",
              "CAMPUS": "GATTN",
              "INSTRUCTION_MODE": "EX",
              "ACAD_GROUP": "SCI"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Financial Reporting",
              "SUBJECT": "ACCT",
              "CATALOG_NBR": "2101",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Elect Com Infrastructure Mgmt",
              "SUBJECT": "MGTS",
              "CATALOG_NBR": "3204",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            }
          ];
      });
    }());
  </script>

@element uqlibrary-courses
@blurb Element providing an overview for student's courses
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-courses
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<script type="text/javascript" src="../moment/moment.js"></script>

<link rel="import" href="../core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../uqlibrary-api/uqlibrary-api-learning-resources.html">
<link rel="import" href="../uqlibrary-api/uqlibrary-api-course-reading-list.html">
<link rel="import" href="../uqlibrary-api/uqlibrary-api-library-guides.html">
<link rel="import" href="../uqlibrary-api/uqlibrary-api-term-dates.html">

<link rel="import" href="uqlibrary-course.html">


<polymer-element name="uqlibrary-courses" layout center attributes="courses">
  <template>
    <link rel="stylesheet" href="uqlibrary-courses.css">

    <paper-tabs id="tabs" selected="{{ selectedTab }}" on-core-select="{{ tabSelected }}" hidden?="{{courses.length == 0}}">
    <uqlibrary-api-learning-resources id="learning_resources"></uqlibrary-api-learning-resources>
    <uqlibrary-api-course-reading-list id="reading_list"></uqlibrary-api-course-reading-list>
    <uqlibrary-api-library-guides id="library_guides"></uqlibrary-api-library-guides>
    <uqlibrary-api-term-dates id="term_dates"></uqlibrary-api-term-dates>

    <template repeat="{{ processedCourses as course }}">
      <paper-tab name="{{ course.courseId }}">
        <div layout vertical center class="menu">
          <span class="tabTitle">{{ course.SUBJECT }}</span>
          <span class="tabTitle">{{ course.CATALOG_NBR }}</span>
        </div>
      </paper-tab>
    </template>
    </paper-tabs>

    <div class="infoWrapper">
      <core-animated-pages id="animatedPages" transitions="slide-from-right" block selected="{{selectedTab}}"
                           on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                           on-core-animated-pages-transition-end="{{transitionEndHandler}}"
        >

        <template repeat="{{ processedCourses as course }}">
          <section id="{{ course.courseId }}" name="{{ course.courseId }}">
            <uqlibrary-course course="{{course}}"></uqlibrary-course>
          </section>
        </template>
     </core-animated-pages>
     </div>
  </template>

  <script>
    Polymer('uqlibrary-courses', {

      /**
       * The `courses` attribute contains information about courses
       *
       * @property courses
       * @type Object
       */

      publish: {
        courses: []
      },
      selectedTab: '',
      learningResources: {},
      processedCourses: [],
      termDates: {},

      // Extend search dates for courses
      termExtendWeeksRange: {
        before: 3,
        after: 1
      },

      ready: function() {
        var that = this;
        var courseIndex = null;

        this.$.learning_resources.addEventListener('uqlibrary-api-learning-resources', function(e) {
          if(e.detail.length > 0) {
            for(var i = 0; i < that.courses.length; i++) {
              if(that.courses[i].courseId == e.detail[0].title) {
                that.courses[i]['learning_resources'] = e.detail[0];
                that.filterReadingLists(that.courses[i]);
                that.filterExamPapers(that.courses[i]);

                var readingListId = that.getReadingListId(that.courses[i].learning_resources.reading_lists);
                if(readingListId != '') {
                  courseIndex = i;
                  that.$.reading_list.get( {code: readingListId} );
                }
              }
            }
          }
          else {
            if(that.selectedTab) {
              for(var i = 0; i < that.courses.length; i++) {
                if(that.courses[i].courseId == that.selectedTab) {
                  that.courses[i]['learning_resources'] = {reading_lists : {items: []}, exam_papers: []};
                }
              }
            }
          }
        });

        this.$.reading_list.addEventListener('uqlibrary-api-course-reading-list', function(e) {
          if(courseIndex != null) {
            var list = e.detail;
            // sort list by item importance
            var importanceList = {'Required': 0, 'Recommended' : 1, 'Further' : 2}
            list.sort(function(a, b){
              // Item with defined importance should be higher
              if(a.hasOwnProperty('importance') && !b.hasOwnProperty('importance')) {
                return -1;
              }
              // Item with defined importance should be higher
              if(!a.hasOwnProperty('importance') && b.hasOwnProperty('importance')) {
                return 1;
              }
              if(!a.hasOwnProperty('importance') && !b.hasOwnProperty('importance')) {
                return 0;
              }

              var impA = (importanceList.hasOwnProperty(a.importance) ? importanceList[a.importance] : 999);
              var impB = (importanceList.hasOwnProperty(b.importance) ? importanceList[b.importance] : 999);
              return b-a;
            });
            if(that.courses[courseIndex]['learning_resources']['reading_lists']){
              that.courses[courseIndex]['learning_resources']['reading_lists']['items'] = e.detail;
            }

          }
        });

        this.$.library_guides.addEventListener('uqlibrary-api-library-guides', function(e) {
          for(var i=0; i < that.courses.length; i++) {
            if(that.courses[i].courseId == that.selectedTab) {
              that.courses[i].library_guides = e.detail;
            }
          }
        });
      },

      get: function(code) {
        if(code) {
          for(var i=0; i < this.processedCourses.length; i++) {
            if(this.processedCourses[i].courseId == code) {
              if( !this.processedCourses[i].hasOwnProperty('learning_resources') ){
                this.$.learning_resources.get( {code:  code });
              }
              if( !this.processedCourses[i].hasOwnProperty('library_guides') ){
                this.$.library_guides.get( {code: this.processedCourses[i].SUBJECT});
              }
            }
          }
        }
        else {
          if(this.processedCourses.length > 0) {
            var _code = this.processedCourses[0].courseId;
            this.selectedTab = _code;
            if( !this.processedCourses[0].hasOwnProperty('learning_resources') ){
              this.$.learning_resources.get( {code: _code} );
            }
            if( !this.processedCourses[0].hasOwnProperty('library_guides') ){
              this.$.library_guides.get( {code: this.processedCourses[0].SUBJECT});
            }
          }
        }

      },

      coursesChanged: function(oldValue, newValue) {
        if(newValue) {
          if(this.courses.length > 0) {
            var termCodes = [];
            for(var i=0; i < this.courses.length; i++) {
              this.courses[i].courseId = this.courses[i].SUBJECT+this.courses[i].CATALOG_NBR;
              if(termCodes.indexOf(this.courses[i].STRM) === -1) {
                termCodes.push(this.courses[i].STRM);
              }
            }

            //sort courses by term
            this.courses.sort(function(a, b) {
              return a.STRM - b.STRM;
            });

            //filter courses to show only current
            var that = this;
            if(termCodes.length > 0) {
              this.$.term_dates.addEventListener('uqlibrary-api-term-dates', function(e) {
                that.termDates = e.detail;
                that.processData() ;
              });
              this.$.term_dates.get({codes: termCodes});
            }
          }
        }
      },

      processData: function () {
        this.processedCourses = this.filterCoursesByTerm();
        //Check if there are 2 or more courses with the same code. If found - remove all but the first course
        var _codes = [];
        for( var i=0; i < this.processedCourses.length; i++) {
          if(_codes.indexOf(this.processedCourses[i].courseId) === -1) {
            _codes.push(this.processedCourses[i].courseId);
          }
          else {
            this.processedCourses.splice(i,1);
          }
        }
        this.fire('uqlibrary-courses-loaded');
      },

      selectedTabChanged: function(oldValue, newValue) {
        // check oldValue to prevent load on init
        if(oldValue!= '' && newValue != '') {
          this.get(newValue);
        }
      },

      transitionPrepareHandler: function() {
        this.transitioning = true;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },
      transitionEndHandler: function() {
        this.transitioning = false;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },

      filterReadingLists: function(course) {

        if(course.learning_resources.reading_lists.length == 0){
          return;
        }

        if(course.learning_resources.reading_lists.length == 1) {
          course.learning_resources.reading_lists = course.learning_resources.reading_lists[0];
          return;
        }

        // Filter reading lists to show only list for course semester
        var term = this.getYearSemesterByCode(course.STRM);
        var semesterString = 'Semester ' + term.semester + ' ' + term.year;
        var found = '';

        for(var i=0; i < course.learning_resources.reading_lists.length; i++) {
          if(course.learning_resources.reading_lists[i].period == semesterString) {
            found = course.learning_resources.reading_lists[i];
            break;
          }
        }

        // If list was found assign it to reading lists, otherwise take the first list from the array
        if(found != '') {
          course.learning_resources.reading_lists = found;
        }
        else {
          course.learning_resources.reading_lists = course.learning_resources.reading_lists[0];
        }
      },

      filterExamPapers: function(course) {
        for(var i=0; i < course.learning_resources.exam_papers.length; i++) {
          if(course.learning_resources.exam_papers[i].course != course.learning_resources.course_title) {

          }
        }
      },

      filterCoursesByTerm: function(course) {
        if(this.termDates){
          var today = moment();
          var that = this;
          return this.courses.filter(function(course) {
            if(that.termDates.hasOwnProperty(course.STRM)){
              var startDate = moment(that.termDates[course.STRM].begin);
              var endDate = moment(that.termDates[course.STRM].end);
              // show current courses plus courses that starts  in 3 weeks or ended 1 week before
              startDate.subtract(that.termExtendWeeksRange.before, 'weeks');
              endDate.add(that.termExtendWeeksRange.after, 'weeks');
              return (today.isAfter(startDate) && today.isBefore(endDate));
            }
            else return true;
          });
        }
      },

      getReadingListId: function(reading_list) {
        var id = '';
        if(reading_list.hasOwnProperty('url')) {
          var url = reading_list.url;
          id = url.substring(url.lastIndexOf('/') + 1);
          if(id.indexOf('.') !== -1) {
            id = id.substring(0, url.indexOf('.'));
          }
        }
        return id;
      },

      getYearSemesterByCode: function(code) {
        var term = code;
        var year = 2000 + parseInt(((parseInt(term) - 5000 + '').substring(0,2))); // i.e. 6520 - semester 1 year 2015, 6480 - semester 3 year 2014,
        var semester = 1;
        var semesterCode = parseInt(term.substr(-2));
        if(semesterCode >= 50 && semesterCode <= 79) {
          semester = 2;
        }
        if(semesterCode >= 80) {
          semester = 3;
        }
        return {year: year, semester: semester};
      }

    });
  </script>

</polymer-element>