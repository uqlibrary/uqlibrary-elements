<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icons/maps-icons.html">
<link rel="import" href="../core-icons/hardware-icons.html">
<link rel="import" href="../core-icons/social-icons.html">
<link rel="import" href="../core-icons/communication-icons.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-label/core-label.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input-decorator.html">
<link rel="import" href="../paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dialog/paper-action-dialog.html">
<link rel="import" href="../uqlibrary-ga/uqlibrary-ga.html">
<link rel="import" href="../uqlibrary-api/uqlibrary-api-account.html">
<!--
Element providing the library main navigation menu using a responsive drawer panel

##### Example

    <uqlibrary-menu></uqlibrary-menu>

@element uqlibrary-menu
@blurb Element providing the library main navigation menu using a responsive drawer panel. Width of drawer should be screen width - app bar height (max-width = 400dp) (source: http://www.google.com/design/spec/layout/structure.html#structure-side-nav)
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-menu
-->
<polymer-element name="uqlibrary-menu" attributes="account">

  <template>
    <link rel="stylesheet" href="uqlibrary-menu.css">
    <uqlibrary-ga id="ga" appName="{{appName}}"></uqlibrary-ga>
    <template if="{{account.hasSession}}">
      <div id="account">
        <div id="gradient" reverse horizontal layout end flex>
          <paper-icon-button icon="lock" title="Logout" on-tap="{{toggleLogout}}" id="askLogout"></paper-icon-button>
          <div id="details" flex>
            <div id="name" class="body2 inverse">{{account.name}}</div>
            <div id="mail" class="body1 inverse">{{account.mail}}</div>
          </div>
        </div>
      </div>

      <core-menu selectedAttribute="" class="divider">
        <paper-item on-tap="{{go}}" link="https://app.library.uq.edu.au/v1/home" id="MyLibrary"><core-icon icon="dashboard"></core-icon> My Library</paper-item>
        <paper-item on-tap="{{go}}" link="https://www.library.uq.edu.au" id="LibraryHome"><core-icon icon="home"></core-icon> UQ Library Home</paper-item>
        <paper-item on-tap="{{toggleFeedback}}" id="askFeedback"><core-icon icon="communication:comment"></core-icon> Feedback</paper-item>
      </core-menu>
    </template>

    <core-menu selectedAttribute="">
      <paper-item on-tap="{{go}}" link="https://app.library.uq.edu.au/v1/booking" id="Booking"><core-icon icon="event"></core-icon> Booking</paper-item>
      <paper-item on-tap="{{go}}" link="https://app.library.uq.edu.au/v1/borrowing" id="showLoansPage"><core-icon icon="maps:local-library"></core-icon> Borrowing</paper-item>
      <paper-item on-tap="{{go}}" link="https://app.library.uq.edu.au/v1/computers" id="showAvailabilityPage"><core-icon icon="hardware:desktop-mac"></core-icon> Computers</paper-item>
      <template if="{{account.classes.length}}">
        <paper-item on-tap="{{go}}" link="https://app.library.uq.edu.au/v1/courses" id="showCoursesPage"><core-icon icon="social:school"></core-icon> Courses</paper-item>
      </template>
      <paper-item on-tap="{{go}}" link="https://app.library.uq.edu.au/v1/hours"  id="showHoursPage"><core-icon icon="schedule"></core-icon> Hours</paper-item>
      <template if="{{account.canMasquerade}}">
        <paper-item on-tap="{{go}}" link="#" id="showMasqueradePage"><core-icon icon="perm-identity"></core-icon> Masquerade</paper-item>
      </template>
      <!--<paper-item><a href="#"><core-icon icon="communication:live-help"></core-icon> Help chat</a></paper-item>-->
    </core-menu>

          <!--Logout dialog-->
          <!--Prevents users from accidentally logging out-->

      <paper-action-dialog id="logoutDialog" heading="Are you sure you wish to logout?" transition="core-transition-bottom" backdrop>
        <p>This will log you out of all your UQ website sessions.</p>
        <paper-button affirmative on-tap="{{toggleLogout}}">Cancel</paper-button>
        <paper-button affirmative autofocus class="colored" on-tap="{{go}}" link="https://www.library.uq.edu.au/logout">Logout</paper-button>
      </paper-action-dialog>

            <!--Feedback dialog-->
            <!--Prompts users to provide feedback through a paper action dialog-->
            <!--Uses UQL API to send details if user is authenticated-->
            <!--Pops a toast to notify users about the success or failure of the feedback transmission-->

    <paper-action-dialog id="feedbackDialog" heading="Tell us what you think" transition="core-transition-bottom" backdrop>
      <p>Your feedback will help us improve MyLibrary.</p>
      <paper-input-decorator label="Your comments (required)" error="input is required!" id="feedbackInput" autofocus>
          <paper-autogrow-textarea>
            <textarea></textarea>
          </paper-autogrow-textarea>
      </paper-input-decorator>

      <core-label horizontal layout>
        <paper-checkbox for></paper-checkbox>
        <div vertical layout>
          <div class="body2">Include my contact information</div>
          <p class="body1">We'll include your name, library barcode and email address so we can get back to you.</p>
        </div>
      </core-label>
      <paper-button affirmative on-tap="{{toggleFeedback}}">Cancel</paper-button>
      <paper-button affirmative class="colored" on-tap="{{sendFeedback}}">Send feedback</paper-button>
    </paper-action-dialog>

    <paper-toast id="feedbackSentToast" role="alert" text="Your feedback has been sent."></paper-toast>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-menu', {

        created: function () {
          this.account = {
            hasSession: false
          };
        },

        ready: function () {


        },

        toggleFeedback: function () {
          this.$.feedbackDialog.toggle();
        },

        toggleLogout: function () {
          this.$.logoutDialog.toggle();
        },

        go: function (e, _, el) {
          var _id = el.getAttribute('id');
          if(_id) {
            this.$.ga.addEvent('Menu Item Clicked', _id);
          }
          document.location.href = el.attributes.link.value;
        },

        sendFeedback: function () {
          var userAccount = this.account.name;
          var userAgent = navigator.userAgent;
          var userComment = this.$.feedbackInput;
          var compiledResponse = "From: " + userAccount + "<br>Comment: " + userComment + "<br>User Agent: " + userAgent;
          var newFeedback = { feedback : {
            subject: "UQ My Library Feedback",
            comment: compiledResponse
            }
          };
          this.$.sendFeedback.post(newFeedback);

          this.$.ga.addEvent('Feedback Sent', userComment);
          console.log("sending feedback!");
          this.$.feedbackSentToast.show();
        },

        linkClicked: function(e, detail, sender) {
          var _id = sender.getAttribute('id');
          if(_id) {
            this.$.ga.addEvent('Link Clicked', _id);
          }
        }

      });
    })();
  </script>

</polymer-element>
