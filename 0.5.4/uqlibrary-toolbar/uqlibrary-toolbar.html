<link href="../polymer/polymer.html" rel="import">
<link rel="import" href="../core-dropdown/core-dropdown.html">
<link rel="import" href="../core-dropdown-menu/core-dropdown-menu.html">
<link rel="import" href="../core-header-panel/core-header-panel.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-input/core-input.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../core-label/core-label.html">
<link rel="import" href="../core-layout-grid/core-layout-grid.html">
<link rel="import" href="../core-layout-trbl/core-layout-trbl.html">
<link rel="import" href="../core-media-query/core-media-query.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-menu/core-submenu.html">
<link rel="import" href="../core-menu-button/core-menu-button.html">
<link rel="import" href="../core-selection/core-selection.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../core-shared-lib/core-shared-lib.html">
<link rel="import" href="../core-style/core-style.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">

<!-- POLYMER PAPER ELEMENTS -->
<link rel="import" href="../paper-dropdown/paper-dropdown.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-input-decorator.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../uqlibrary-a11y-link/uqlibrary-a11y-link.html">

<!-- MATERIAL DESIGN -->
<link rel="import" href="../font-roboto/roboto.html">

<!--

Reusable toolbar element that comes with search UI/UX
Can include optional menu options

##### Example

<uqlibrary-toolbar>Click me or press Enter</uqlibrary-toolbar>

@element uqlibrary-toolbar
@blurb Reusable toolbar containing common styling and dynamic attributes such as title and link, and context-relevant search
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-toolbar
-->

<polymer-element name="uqlibrary-toolbar" attributes="appTitle appTitleLink appLinks searchPlaceholderText">
  <!--<polymer-element name="uq-toolbar" attributes="pageTitle appTitle uq-links local-options site-search nav-menu">-->

  <template>
    <core-toolbar id="mainToolbar">

      <!--Initial toolbar UI which is visible by default-->
      <!--TODO: bubble up this event so the scaffolding can use it-->
      <div id="hamburgerMenuIcon">
        <paper-icon-button icon="menu"
                           on-tap="{{menuClicked}}">
        </paper-icon-button>
      </div>

      <div flex id="toolbarTitle">
        <a href="{{appTitleLink}}" class="glow applicationName">{{appTitle}}</a>
      </div>

      <div id="expandSearch" on-tap="{{activateSearch}}">
        <uqlibrary-a11y-link>
          <paper-icon-button icon="search"></paper-icon-button>
        </uqlibrary-a11y-link>
      </div>

      <!--Search UI which is only visible after user clicks 'search'-->
      <div hidden id="backArrow" on-tap="{{deactivateSearch}}">
        <uqlibrary-a11y-link>
          <paper-icon-button icon="arrow-back"></paper-icon-button>
        </uqlibrary-a11y-link>
      </div>
      <div hidden flex id="leftFlex" class="offCanvas">

        <core-a11y-keys target="{{$.searchInputField}}"
                        keys="up down enter esc"
                        on-keys-pressed="{{onSearchKeys}}"></core-a11y-keys>


        <paper-input-decorator label="{{searchPlaceholderText}}" id="searchFieldWrapper">
          <input is="core-input" id="searchInputField" value="{{searchFieldValue}}">
        </paper-input-decorator>

        <paper-dropdown id="autosuggest"
                        class="no-padding"
                        relatedTarget="{{$.searchFieldWrapper}}"
                        autoFocusDisabled="true">
          <core-selector selected="{{selectedSuggestion}}"
                         selectedAttribute=""
                         id="suggestionSelector">
            <template repeat="{{suggestions as item}}">
              <paper-item on-tap="{{onTapSuggestion}}">
                <div class="{{type + ' truncate' + (recent ? ' recent' : '')}}">{{item.text}}</div>
              </paper-item>
            </template>
          </core-selector>
        </paper-dropdown>

      </div>
      <div hidden id="rightFlex" on-tap="{{searchButtonClicked}}">
        <uqlibrary-a11y-link>
          <paper-icon-button icon="search" id="searchButton"></paper-icon-button>
        </uqlibrary-a11y-link>
      </div>

      <template if="{{(appLinks.length > 0)}}">
        <div id="appLinksIcon">
          <paper-menu-button>
            <paper-icon-button icon="more-vert"></paper-icon-button>
            <paper-dropdown class="dropdown" halign="right">
              <core-menu class="menu">
                <template repeat="{{link in appLinks}}">
                  <uqlibrary-a11y-link>
                    <paper-item>
                      <a href="{{link.url}}" on-click="{{ linkClicked }}" data-title="{{link.label}}">{{link.label}}</a>
                    </paper-item>
                  </uqlibrary-a11y-link>
                </template>
              </core-menu>
            </paper-dropdown>
          </paper-menu-button>
        </div>
      </template>

    </core-toolbar>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
  </template>
  <script>
    Polymer('uqlibrary-toolbar', {

      // TODO: uqLinks variable should be set by the uqLinks attribute
      animationFrameLength: 150,
      searchAutosuggestHandler: null,
      searchFieldValue: '',
      suggestions: [],
      selectedSuggestion: 0,
      skipValueChangeHandle: false,
      previousKey: '',
      ready: function () {
        if (!this.searchPlaceholderText) {
          this.searchPlaceholderText = "Search";
        }

        this.initAutosuggestHandler();
      },

      created: function () {
        // hint that appLinks is an array
        this.appLinks = [];

      },

      // TODO: loop through a function to do this animation

      activateSearch: function () {
        var that = this;

        setTimeout(function () {
          that.$.mainToolbar.classList.toggle('turnWhite');
          that.$.hamburgerMenuIcon.classList.toggle('invisible');
          that.$.toolbarTitle.classList.toggle('invisible');
          that.$.expandSearch.classList.toggle('invisible');
          if (that.$.appLinksIcon != undefined) {
            that.$.appLinksIcon.classList.toggle('invisible');
          }
        }, 0);

        setTimeout(function () {
          that.$.hamburgerMenuIcon.setAttribute('hidden', true);
          that.$.toolbarTitle.setAttribute('hidden', true);
          that.$.expandSearch.setAttribute('hidden', true);
          if (that.$.appLinksIcon != undefined) {
            that.$.appLinksIcon.setAttribute('hidden', true);
          }
          that.$.backArrow.removeAttribute('hidden');
          that.$.leftFlex.removeAttribute('hidden');
          that.$.rightFlex.removeAttribute('hidden');
          that.$.searchInputField.focus();
        }, that.animationFrameLength);
      },

      deactivateSearch: function () {
        var that = this;

        setTimeout(function () {
          that.$.hamburgerMenuIcon.removeAttribute('hidden');
          that.$.toolbarTitle.removeAttribute('hidden');
          that.$.expandSearch.removeAttribute('hidden');
          if (that.$.appLinksIcon != undefined) {
            that.$.appLinksIcon.removeAttribute('hidden');
          }
          that.$.backArrow.setAttribute('hidden', true);
          that.$.leftFlex.setAttribute('hidden', true);
          that.$.rightFlex.setAttribute('hidden', true);
        }, 0);

        setTimeout(function () {
          that.$.mainToolbar.classList.toggle('turnWhite');
          that.$.hamburgerMenuIcon.classList.toggle('invisible');
          that.$.toolbarTitle.classList.toggle('invisible');
          that.$.expandSearch.classList.toggle('invisible');
          if (that.$.appLinksIcon != undefined) {
            that.$.appLinksIcon.classList.toggle('invisible');
          }
        }, that.animationFrameLength);
      },

      menuClicked: function () {
        this.fire('uqlibrary-toolbar-menu-clicked');
      },

      searchButtonClicked: function () {
        this.search();
      },

      searchFieldValueChanged: function (oldValue, newValue) {
        if (this.skipValueChangeHandle) {
          this.skipValueChangeHandle = false;
          return;
        }
        this.fire('uqlibrary-toolbar-search-value-changed', {value: newValue});
      },

      initAutosuggestHandler: function () {
        var that = this;
        this.addEventListener('uqlibrary-toolbar-search-suggestions-loaded', function (e) {
          var _data = e.detail.data;
          if (_data.constructor === Array) {
            that.suggestions = _data;
            that.selectedSuggestion = -1;
            that.showSuggestions();
          }


        });
      },
      onSearchKeys: function (ev) {
        if (ev.detail.key === 'down' && this.selectedSuggestion < (this.suggestions.length - 1)) {
          this.selectedSuggestion++;
        }
        else if (ev.detail.key === 'up') {
          if (this.selectedSuggestion > 0) {
            this.selectedSuggestion--;
          } else {
            this.selectedSuggestion = -1;
          }
        }
        else if (ev.detail.key === 'enter') {
          if (
                  this.selectedSuggestion >= 0 &&
                  this.previousKey &&
                  (this.previousKey === 'up' || this.previousKey === 'down')
          ) {
            this.async(function () {
              this.suggestionSearch();
            }, 100);
          } else {
            this.search();
          }
        }
        else if (ev.detail.key === 'esc') {
          this.selectedSuggestion = -1;
          this.$.autosuggest.opened = false;
          this.$.filters.opened = false;
        }
        this.previousKey = ev.detail.key;
      },

      onTapSuggestion: function () {
        this.async(function () {
          this.suggestionSearch();
        }, 100);
      },

      suggestionSearch: function () {
        var suggestion = this.suggestions[this.selectedSuggestion];

        if (suggestion.hasOwnProperty('url')) {
          window.location.href = suggestion.url;
        } else {
          this.skipValueChangeHandle = true;
          this.searchFieldValue = suggestion.text;
          this.search();
          this.$.autosuggest.opened = false;
        }

      },

      search: function () {
        this.fire('uqlibrary-toolbar-search-submitted', {searchTerm: this.searchFieldValue});
      },


      showSuggestions: function () {
        this.async(function () {
          if (this.suggestions.length > 0 && !this.searching) {
            this.$.autosuggest.opened = true;
          }
          else if (this.$.autosuggest.opened) {
            this.$.autosuggest.opened = false;
          }
        }, 100);
      },

      clearSearchForm: function () {
        this.skipValueChangeHandle = true;
        this.searchFieldValue = '';
      },

      linkClicked: function(e, detail, sender) {
        var _id = sender.getAttribute('id');
        var _title = sender.getAttribute('data-title');

        this.fire('uqlibrary-toolbar-link-clicked', sender.getAttribute('href'));
      }

    });
  </script>
</polymer-element>